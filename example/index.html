<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>wings</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/solid.min.css" rel="stylesheet">
  <link rel=icon href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15/svgs/solid/feather-alt.svg>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>

  <style>
    #text {
      background-color: transparent;
      position: absolute;
      left: 0px;
      top: 0px;
      z-index: 10;
    }

    .container {
      position: relative;
    }

    .form-select {
      width: fit-content;
      display: inline-block;
    }

    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>

<body style='background-color:lightgray' onload='connect("ws://localhost:7681");'>

  <!-- wrapper -->
  <div id="wrapper">

    <!-- page content -->
    <div class="avoid-nav" id="page-content-wrapper">

      <div class='btn btn-primary'
        style='width:100%; height: 50px; background-color:black; color:white; border-color:black; border-radius: 0px;'
        onclick='connect();'>
        wings360
      </div>

      <hr>

      <div class="container-fluid">

        <div class="" style='display:inline-block'>
          <button class='float-right btn btn-primary' id='button-save-png' onclick='savePNG()'>export</button>
        </div>
        <div style='display:inline-block'>
          <input class='btn btn-light' onchange='visualizer.setHeight();' style='width:100px; color:black'
            id='input-height' type='number' step='100'></input>
          <label class='form-check-label' for='height-input'>height</label>
          &nbsp;&nbsp;
        </div>

        <div style='display:inline-block'>
          <select class='form-select' id='clip-dropdown' onchange='flux.draw();'>
            <option>[clip off]</option>
            <option>X+</option>
            <option>X-</option>
            <option>Y+</option>
            <option>Y-</option>
            <option>Z+</option>
            <option>Z-</option>
          </select>
        </div>
        &nbsp;&nbsp;
        <input class='form-range' style='width:125px; display: inline-block' type='range' id='clip-distance'
          onchange='flux.draw();' value='0'></input>
        &nbsp;&nbsp;
        <div style='display:inline-block'>
          <select class='form-select' id='colormap-dropdown' onchange='flux.colormap(); flux.draw();'>
            <option>[colormap]</option>
            <option>blue-white-red</option>
            <option>blue-green-red</option>
            <option>parula</option>
            <option>jet</option>
            <option>hsv</option>
            <option>hot</option>
            <option>viridis</option>
            <option>giraffe</option>
          </select>
        </div>
        <hr>
        <div style='display:inline-block'>
          <button class='btn btn-primary' id='reset-view' onclick=''>center</button>
        </div>
        <select class='form-select' id='field-dropdown' onchange=''></select>
        &nbsp;&nbsp;
        <div class='form-check' style='display:inline-block'>
          <input class='form-check-input' id='checkbox-edges' type='checkbox' checked
            onchange='flux.toggleEdges(); flux.draw();'></input>
          <label class='form-check-label' for='checkbox-edges'>edges</label>
        </div>
        <div class='form-check' style='display:inline-block'>
          <input class='form-check-input' id='checkbox-triangles' type='checkbox' checked
            onchange='flux.toggleTriangles(); flux.draw();'></input>
          <label class='form-check-label' for='checkbox-triangles'>triangles</label>
        </div>
        <div class='form-check' style='display:inline-block'>
          <input class='form-check-input' id='checkbox-points' type='checkbox'
            onchange='flux.togglePoints(); flux.draw();'></input>
          <label class='form-check-label' for='checkbox-points'>points</label>
        </div>
        <div class='form-check' style='display:inline-block'>
          <input class='form-check-input' id='checkbox-lighting' type='checkbox' checked
            onchange='flux.lighting = !flux.lighting; flux.draw();'></input>
          <label class='form-check-label' for='checkbox-lighting'>lighting</label>
        </div>
        <div class='form-check' style='display:inline-block'>
          <input class='form-check-input' id='checkbox-lighting' type='checkbox'
            onchange='flux.toggleNumbers(); flux.draw();'></input>
          <label class='form-check-label' for='checkbox-numbers'>numbers</label>
        </div>
        <div class='form-check' style='display:inline-block'>
          <button class='btn btn-primary' id='fps-button' onclick='estimateFps();'>FPS</button>
          <label class='form-check-label' for='fps-button' id='fps-label'></label>
        </div>
        <div class='form-check' style='display:inline-block'>
          <label class='form-check-label' id='size-label'></label>
        </div>
        <hr>
        <div class='container'>
          <ul class="nav nav-tabs" id="views-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="view0-tab" data-bs-toggle="tab" data-bs-target="#view0" type="button" role="tab" aria-controls="view0" aria-selected="true">View0</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="view1-tab" data-bs-toggle="tab" data-bs-target="#view1" type="button" role="tab" aria-controls="view1" aria-selected="false">View1</button>
            </li>
            <li class="nav-item" role="presentation">
              <!--<button class="nav-link" id="new-view-tab" data-bs-toggle="tab" data-bs-target="#new-view" type="button" role="tab" aria-controls="new-view" aria-selected="false">+</button>-->
              <button class="nav-link" id="new-view-tab" type="button" role="tab" onclick="newView()">+</button>
            </li>
          </ul>
          <br>
          <div class="tab-content" id="views-tab-content">
            <div class="tab-pane fade show active" id="view0" role="tabpanel" aria-labelledby="view0-tab">
                <img class='center' id='image' width=500 height=500 style="border: 2px solid black;" /> <br>
            </div>
            <div class="tab-pane fade" id="view1" role="tabpanel" aria-labelledby="view1-tab">...</div>
            <div class="tab-pane fade" id="new-view" role="tabpanel" aria-labelledby="new-vew-tab">...</div>
          </div>
          <center>
            <div>
              <input id="quality" type="range" min="5" max="100" step="5" value="80" onchange="setQuality();">
              <label for="quality">quality</label>
            </div>
          </center>
        </div>
        <hr>
      </div> <!-- container-fluid -->
    </div> <!-- page-content-wrapper -->
  </div> <!-- wrapper -->
  </main>
</body>

<script>

  let n_views = 1;
  let newView = function() {
    let tabs = document.getElementById('views-tab-content');
    let tab = document.createElement('div', {
      'class': 'tab-pane fade', 
      'id': 'view' + n_views,
      'role': 'tabpanel',
      'aria-labelledby': 'view' + n_views + '-tab'
    });
    let view = document.createElement('img');
    view.className = 'center';
    view.id = 'image' + n_views;
    view.style = 'border: 2px solid black';
    view.width = 100;
    view.height = 100;
    console.log('new view');
    tab.appendChild(view);
    tabs.appendChild(tab);

    let panel = document.getElementById('views-tabs');
    let item = document.createElement('li', {'class': 'nav-item', 'role': 'presentation'});
    let button = document.createElement('button');
    button.setAttribute('class', 'nav-link');
    button.setAttribute('id', 'view' + n_views + '-tab');
    button.setAttribute('data-bs-toggle', 'tab');
    //   'data-bs-target': '#view' + n_views,
    //   'type': 'button',
    //   'role': 'tab',
    //   'aria-controls': 'view' + n_views,
    //   'aria-selected': true
    // });
    // class="nav-link" id="view1-tab" data-bs-toggle="tab" data-bs-target="#view1" type="button" role="tab" aria-controls="view1" aria-selected="false">View1</button>
    button.innerHTML = 'View' + n_views;
    item.appendChild(button);
    panel.appendChild(item);

    n_views++;

    // add client to websocket server
  }


  let ws;
  let img = document.getElementById('image');
  let connect = function (url) {
    let url_default = "ws://localhost:{WEBSOCKET_PORT}";
    if (window.location.protocol == 'file:')
      url_default = "ws://localhost:7682";

    if (!url) url = prompt('connect to websocket server:', url_default);
    if (url == undefined) return;
    let websocket = window['MozWebSocket'] ? window['MozWebSocket'] : window['WebSocket'];

    ws = new websocket(url);
    ws.onopen = function (e) {
      console.log('opened websocket connection');
      setQuality();
    }
    ws.onclose = function (evt) { console.log('connection closed'); }
    ws.onmessage = async (evt) => {
      const w = 800;
      const h = 600;
      if (w != img.width) img.width = w;
      if (h != img.height) img.height = h;
      const data = evt.data;
      img.src = 'data:image/jpg;base64,' + data;
      document.getElementById('size-label').innerHTML = parseInt(data.length / 1000) + ' kB';
    }
  }

  let dragging = false;
  let scrolling = undefined, scrolling_timeout;
  let quality0 = document.getElementById('quality').value;
  img.addEventListener('mousedown', function (e) {
    e.preventDefault();
    quality0 = document.getElementById('quality').value;
    document.getElementById('quality').value = 5;
    setQuality();
    dragging = true;
  });

  img.addEventListener('mouseup', function (e) {
    e.preventDefault();
    dragging = false;
    document.getElementById('quality').value = quality0;
    setQuality();
  });

  img.addEventListener('mousemove', function (e) {
    const x = ("0000" + e.clientX).slice(-5);
    const y = ("0000" + e.clientY).slice(-5);
    const msg = 'M' + (dragging ? 'D' : 'd') + x + y;
    ws.send(msg);
  });

  img.addEventListener('mousewheel', function (e) {
    e.preventDefault();
    if (!scrolling) { // initial scroll event
      quality0 = document.getElementById('quality').value;
      document.getElementById('quality').value = 5;
      setQuality();
      scrolling = true;
      return;
    }
    window.clearTimeout(scrolling_timeout);
    // set a timeout to run after scrolling ends
    scrolling_timeout = setTimeout(function () {
      document.getElementById('quality').value = quality0;
      setQuality();
      scrolling = false;
    }, 60);
    const msg = 'W' + (e.deltaY > 0 ? '-' : '+');
    ws.send(msg);
  }, false);

  setQuality = function () {
    ws.send('Q' + document.getElementById('quality').value);
  };

  window.onresize = function () {
  }

  function estimateFps() {
    let old_cb = ws.onmessage;
    let angle;
    let frame = 0;
    const start = Date.now();
    ws.onmessage = function (evt) {
      if (frame++ > 1000) {
        ws.onmessage = old_cb;
        return;
      }
      img.src = 'data:image/jpg;base64,' + evt.data;
      const angle = ("000" + frame).slice(-3);
      ws.send('R' + angle);
      const end = Date.now();
      const t = (end - start) / 1000;
      document.getElementById('fps-label').innerHTML = (frame / t).toFixed(1);
    }
    setQuality();
    document.getElementById('fps-label').innerHTML = '';
  }

</script>

</html>